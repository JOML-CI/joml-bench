# How to run

With JAVA_HOME and PATH pointing to a Panama vectorIntrinsics build, run:

```
./mvnw package && java -jar target/bench.jar
```

Without having a local Panama vectorIntrinsics build, run:
```
./ci.sh
```
This will shallow-clone the [GitHub mirror of the Panama vectorIntrinsics branch](https://github.com/openjdk/panama-vector/tree/vectorIntrinsics), build the JDK and execute the benchmarks using it. Make sure your system fulfills the [OpenJDK build requirements](https://github.com/openjdk/panama-vector/blob/vectorIntrinsics/doc/building.md). See the section "Clean Ubuntu Setup" below for a clean Ubuntu setup.
The space requirements for such a cloned and fully built JDK is ~5.6GB, which will reside inside of the panama-vector directory.
In addition, the hsdis utility library is built and installed into the JDK's lib directory.

## Clean Ubuntu Setup (tested on Ubuntu 22.04)

```
sudo apt install -y libasound2-dev \
                    libfontconfig1-dev \
                    libcups2-dev \
                    libx11-dev \
                    libxext-dev \
                    libxrender-dev \
                    libxrandr-dev \
                    libxtst-dev \
                    libxt-dev \
                    git \
                    zip \
                    unzip \
                    automake \
                    autoconf \
                    build-essential \
                    openjdk-18-jdk
```

## Seeing the disassembly

In order to see the x86 code generated by the JIT compiler for all methods, run:
```
java --add-modules jdk.incubator.vector -XX:+UnlockDiagnosticVMOptions -XX:CompileCommand=print,*Matrix*.* -cp target/bench.jar bench.C2
```
The x86 code is then printed to stdout. This requires the hsdis utility library available in the $JAVA_HOME/lib directory, as is provided by `./ci.sh`.

# Results

## Ryzen 5950X and JDK 20 build 20
### With -Djdk.incubator.vector.VECTOR_ACCESS_OOB_CHECK=0
```
java -version
openjdk version "20-ea" 2023-03-21
OpenJDK Runtime Environment (build 20-ea+20-1466)
OpenJDK 64-Bit Server VM (build 20-ea+20-1466, mixed mode, sharing)
```
Results:
```
Benchmark                      Mode  Cnt   Score   Error  Units
Bench.Matrix4f_invert          avgt    5  20,748 ± 0,519  ns/op
Bench.Matrix4f_storePutBB      avgt    5   4,002 ± 0,072  ns/op
Bench.Matrix4f_storePutFB      avgt    5   3,348 ± 0,050  ns/op
Bench.Matrix4f_storeU          avgt    5   2,073 ± 0,046  ns/op
Bench.Matrix4f_transpose       avgt    5   2,681 ± 0,027  ns/op
Bench.Matrix4fn_mulAVX         avgt    5   6,230 ± 0,141  ns/op
Bench.Matrix4fn_mulSSE         avgt    5   7,377 ± 0,148  ns/op
Bench.Matrix4fn_noop           avgt    5   4,623 ± 0,089  ns/op
Bench.Matrix4fvArr_invert128   avgt    5  81,263 ± 0,959  ns/op
Bench.Matrix4fvArr_storePutFB  avgt    5   8,815 ± 0,124  ns/op
Bench.Matrix4fvArr_storeU      avgt    5   2,018 ± 0,047  ns/op
Bench.Matrix4fvArr_storeV256   avgt    5   7,767 ± 0,073  ns/op
Bench.Matrix4fvArr_storeV512   avgt    5  23,319 ± 0,517  ns/op
Bench.Matrix4fvArr_transpose   avgt    5  64,088 ± 0,754  ns/op
Bench.mul128LoopArr            avgt    5   8,462 ± 0,074  ns/op
Bench.mul128LoopBB             avgt    5  16,330 ± 0,113  ns/op
Bench.mul128UnrolledArr        avgt    5   8,477 ± 0,192  ns/op
Bench.mul128UnrolledBB         avgt    5  16,448 ± 0,128  ns/op
Bench.mul256Arr                avgt    5   8,622 ± 0,158  ns/op
Bench.mul256BB                 avgt    5  16,770 ± 0,120  ns/op
Bench.mulAffineScalarFma       avgt    5   7,603 ± 0,160  ns/op
Bench.mulScalar                avgt    5  11,209 ± 0,262  ns/op
Bench.mulScalarFma             avgt    5  10,252 ± 0,070  ns/op
```
